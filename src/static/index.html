<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHEMI - Trợ lý Hóa học</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%233B82F6'/%3E%3Cstop offset='100%25' stop-color='%2360A5FA'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='32' height='32' rx='8' fill='url(%23g)'/%3E%3Cpath d='M12 8v6l-4 8a2 2 0 002 2h12a2 2 0 002-2l-4-8V8' stroke='white' stroke-width='2' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3Cpath d='M10 8h12' stroke='white' stroke-width='2' stroke-linecap='round'/%3E%3Ccircle cx='14' cy='19' r='1.5' fill='white'/%3E%3Ccircle cx='18' cy='17' r='1' fill='white'/%3E%3C/svg%3E">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ===== RESET & BASE ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Colors - Academic Navy Theme (dễ đọc, học thuật) */
            --bg-primary: #0f172a;
            --bg-secondary: #111827;
            --bg-input: #1e293b;
            --bg-hover: #334155;
            --bg-message: #1e293b;

            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;

            --accent-color: #3B82F6;
            --accent-hover: #2563EB;
            --accent-glow: rgba(59, 130, 246, 0.3);
            --accent-light: #60A5FA;

            --border-color: #1e293b;
            --border-light: #334155;

            /* Feature card colors */
            --feature-blue: #3B82F6;
            --feature-green: #22c55e;
            --feature-cyan: #06b6d4;
            --feature-purple: #a855f7;

            /* Spacing */
            --sidebar-width: 260px;
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 12px;
            --radius-xl: 16px;
        }

        html, body {
            height: 100%;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 16px;
            line-height: 1.6;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            font-feature-settings: 'cv02', 'cv03', 'cv04', 'cv11';
        }

        /* ===== LAYOUT ===== */
        .app {
            display: flex;
            height: 100vh;
        }

        /* ===== SIDEBAR ===== */
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, #111827 0%, #0f172a 100%);
            border-right: 1px solid rgba(59, 130, 246, 0.15);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            position: relative;
        }

        .sidebar::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 1px;
            background: linear-gradient(180deg, rgba(59, 130, 246, 0.2) 0%, rgba(59, 130, 246, 0.05) 50%, rgba(59, 130, 246, 0.2) 100%);
        }

        /* ===== MOBILE & TABLET RESPONSIVENESS ===== */

        /* Tablets and below - hide sidebar */
        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }

            /* Ensure main takes full width */
            .main {
                width: 100%;
            }
        }

        .sidebar-header {
            padding: 12px 16px;
            min-height: 57px;
            display: flex;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: opacity 0.15s ease;
        }

        .logo:hover {
            opacity: 0.8;
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent-color), var(--accent-light));
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .logo-text {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.3px;
        }

        .logo-subtitle {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .sidebar-nav {
            padding: 12px;
            flex: 1;
            overflow-y: auto;
        }

        .new-chat-btn {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 14px;
            background: transparent;
            border: 1px dashed var(--border-light);
            color: var(--text-secondary);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.15s ease;
            margin-bottom: 12px;
        }

        .new-chat-btn:hover {
            background-color: var(--bg-hover);
            border-color: var(--text-secondary);
            color: var(--text-primary);
        }

        .nav-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 8px 12px 8px;
            margin-top: 8px;
        }

        .chat-history {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .history-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 13px;
            transition: all 0.15s ease;
            text-align: left;
            width: 100%;
        }

        .history-item:hover {
            background-color: var(--bg-hover);
            color: var(--text-primary);
        }

        .history-item.active {
            background-color: var(--bg-hover);
            color: var(--text-primary);
        }

        .history-item-icon {
            font-size: 14px;
            opacity: 0.6;
        }

        .history-item-content {
            flex: 1;
            min-width: 0;
        }

        .history-item-title {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .history-item-date {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .history-delete-btn {
            opacity: 0;
            padding: 4px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.15s ease;
        }

        .history-item:hover .history-delete-btn {
            opacity: 1;
        }

        .history-delete-btn:hover {
            background-color: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        /* ===== MAIN CONTENT ===== */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            background: linear-gradient(180deg, #111827 0%, #0f172a 50%, #020617 100%);
            position: relative;
            overflow: hidden;
        }

        /* Animated Chemistry Icons Background */
        .chem-bg {
            position: absolute;
            inset: 0;
            pointer-events: none;
            overflow: hidden;
            z-index: 0;
        }

        .chem-icon {
            position: absolute;
            opacity: 0.08;
            color: #60a5fa;
            animation: float 20s ease-in-out infinite;
        }

        .chem-icon svg {
            width: 100%;
            height: 100%;
            stroke: currentColor;
            stroke-width: 1.2;
            fill: none;
        }

        .chem-icon:nth-child(1) { width: 90px; height: 90px; top: 8%; left: 12%; animation-delay: 0s; animation-duration: 25s; }
        .chem-icon:nth-child(2) { width: 68px; height: 68px; top: 20%; right: 18%; animation-delay: -5s; animation-duration: 22s; }
        .chem-icon:nth-child(3) { width: 82px; height: 82px; bottom: 28%; left: 8%; animation-delay: -10s; animation-duration: 28s; }
        .chem-icon:nth-child(4) { width: 60px; height: 60px; top: 55%; right: 12%; animation-delay: -3s; animation-duration: 20s; }
        .chem-icon:nth-child(5) { width: 75px; height: 75px; bottom: 12%; right: 22%; animation-delay: -8s; animation-duration: 24s; }
        .chem-icon:nth-child(6) { width: 52px; height: 52px; top: 42%; left: 22%; animation-delay: -12s; animation-duration: 26s; }
        .chem-icon:nth-child(7) { width: 72px; height: 72px; top: 3%; right: 32%; animation-delay: -15s; animation-duration: 23s; }
        .chem-icon:nth-child(8) { width: 63px; height: 63px; bottom: 42%; left: 32%; animation-delay: -7s; animation-duration: 27s; }
        .chem-icon:nth-child(9) { width: 55px; height: 55px; top: 35%; right: 45%; animation-delay: -18s; animation-duration: 30s; }
        .chem-icon:nth-child(10) { width: 78px; height: 78px; bottom: 55%; right: 8%; animation-delay: -2s; animation-duration: 21s; }
        .chem-icon:nth-child(11) { width: 65px; height: 65px; top: 70%; left: 45%; animation-delay: -14s; animation-duration: 29s; }
        .chem-icon:nth-child(12) { width: 58px; height: 58px; bottom: 8%; left: 55%; animation-delay: -9s; animation-duration: 24s; }

        @keyframes float {
            0%, 100% {
                transform: translate(0, 0) rotate(0deg);
                opacity: 0.06;
            }
            25% {
                transform: translate(30px, -20px) rotate(5deg);
                opacity: 0.1;
            }
            50% {
                transform: translate(-20px, 30px) rotate(-5deg);
                opacity: 0.08;
            }
            75% {
                transform: translate(20px, 20px) rotate(3deg);
                opacity: 0.09;
            }
        }

        .main > *:not(.chem-bg) {
            position: relative;
            z-index: 1;
        }

        /* ===== HEADER ===== */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 20px;
            min-height: 57px;
        }

        @media (max-width: 480px) {
            .header {
                padding: 10px 12px;
            }
        }

        @media (min-width: 1024px) {
            .header {
                padding: 14px 32px;
            }
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .mobile-home-btn {
            display: none;
            -webkit-appearance: none;
            appearance: none;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background-color: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.15s ease;
            flex-shrink: 0;
            padding: 0;
            margin: 0;
            outline: none;
        }

        .mobile-home-btn:hover {
            background-color: var(--bg-hover);
            border-color: var(--accent-color);
        }

        .mobile-home-btn:active {
            transform: scale(0.95);
        }

        .mobile-home-btn svg {
            width: 20px;
            height: 20px;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
            display: block;
        }

        /* Show home button on mobile devices (Safari, Chrome, etc) */
        @media (max-width: 768px) {
            .mobile-home-btn {
                display: flex !important;
                -webkit-tap-highlight-color: transparent;
            }
        }

        @media (max-width: 480px) {
            .mobile-home-btn {
                width: 36px;
                height: 36px;
            }

            .mobile-home-btn svg {
                width: 18px;
                height: 18px;
            }
        }

        .model-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background-color: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 15px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .model-badge-icon {
            font-size: 14px;
        }

        @media (max-width: 480px) {
            .model-badge {
                padding: 8px 12px;
                font-size: 14px;
            }

            .model-badge span:first-child {
                max-width: 150px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background-color: rgba(59, 130, 246, 0.1);
            border-radius: var(--radius-sm);
            font-size: 12px;
            color: var(--accent-color);
        }

        @media (max-width: 480px) {
            .status-badge {
                padding: 5px 10px;
                font-size: 11px;
                gap: 5px;
            }

            .status-badge span {
                display: none;
            }

            .status-dot {
                display: block;
            }
        }

        .status-dot {
            width: 6px;
            height: 6px;
            background-color: var(--accent-color);
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }

        @media (max-width: 480px) {
            .status-dot {
                width: 8px;
                height: 8px;
            }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* ===== CHAT AREA ===== */
        .chat-area {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        /* Welcome Screen */
        .welcome {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }

        @media (max-width: 480px) {
            .welcome {
                padding: 24px 16px;
            }
        }

        @media (min-width: 1024px) {
            .welcome {
                padding: 48px 32px;
                max-width: 900px;
            }
        }

        .welcome-icon {
            width: 72px;
            height: 72px;
            background: linear-gradient(135deg, var(--accent-color), var(--accent-light));
            border-radius: var(--radius-xl);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            margin-bottom: 24px;
            box-shadow: 0 8px 32px var(--accent-glow);
            animation: iconFloat 3s ease-in-out infinite;
            position: relative;
        }

        .welcome-icon::before {
            content: '';
            position: absolute;
            inset: -4px;
            background: linear-gradient(135deg, var(--accent-color), var(--accent-light));
            border-radius: var(--radius-xl);
            opacity: 0.3;
            filter: blur(12px);
            z-index: -1;
            animation: iconGlow 3s ease-in-out infinite;
        }

        @keyframes iconFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        @keyframes iconGlow {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.1); }
        }

        .welcome-title {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 12px;
            text-align: center;
            letter-spacing: -0.5px;
            color: #f8fafc;
            text-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
        }

        .welcome-subtitle {
            font-size: 18px;
            color: #e2e8f0;
            text-align: center;
            margin-bottom: 40px;
            max-width: 520px;
            line-height: 1.7;
        }

        .features {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            width: 100%;
            max-width: 560px;
        }

        /* Center the 5th button on its own row */
        .feature-card:nth-child(5) {
            grid-column: 1 / -1;
            max-width: 270px;
            justify-self: center;
        }

        /* Mobile: single column */
        @media (max-width: 560px) {
            .features {
                grid-template-columns: 1fr;
            }

            .feature-card:nth-child(5) {
                grid-column: auto;
                max-width: none;
                justify-self: stretch;
            }
        }

        /* Large tablets and small laptops: increase width */
        @media (min-width: 768px) and (max-width: 1024px) {
            .features {
                max-width: 640px;
                gap: 14px;
            }

            .feature-card:nth-child(5) {
                max-width: 310px;
            }
        }

        /* Desktop: wider layout */
        @media (min-width: 1024px) {
            .features {
                max-width: 700px;
                gap: 16px;
            }

            .feature-card:nth-child(5) {
                max-width: 340px;
            }
        }

        .feature-card {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 16px;
            background-color: #020617;
            border: 1px solid #1e293b;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
        }

        .feature-card:hover {
            background-color: #0f172a;
            border-color: #38bdf8;
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(56, 189, 248, 0.2);
        }

        .feature-card:hover .feature-icon {
            transform: scale(1.1);
        }

        .feature-icon {
            width: 40px;
            height: 40px;
            background-color: rgba(59, 130, 246, 0.15);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
            color: var(--accent-color);
            transition: all 0.2s ease;
        }

        /* Different colors for each feature */
        .feature-card.iupac .feature-icon {
            background-color: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }
        .feature-card.speech .feature-icon {
            background-color: rgba(34, 197, 94, 0.2);
            color: #4ade80;
        }
        .feature-card.structure .feature-icon {
            background-color: rgba(6, 182, 212, 0.2);
            color: #22d3ee;
        }
        .feature-card.image .feature-icon {
            background-color: rgba(168, 85, 247, 0.2);
            color: #c084fc;
        }

        .feature-icon svg {
            width: 20px;
            height: 20px;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
        }

        .feature-content {
            flex: 1;
            min-width: 0;
        }

        .feature-title {
            font-size: 16px;
            font-weight: 600;
            color: #f1f5f9;
            margin-bottom: 4px;
        }

        .feature-desc {
            font-size: 13px;
            color: #94a3b8;
            line-height: 1.5;
        }

        /* Messages */
        .messages {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
        }

        @media (max-width: 768px) {
            .messages {
                padding: 16px;
                max-width: 100%;
            }
        }

        @media (min-width: 1440px) {
            .messages {
                max-width: 1100px;
            }
        }

        .message {
            display: flex;
            gap: 12px;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }

        .message-avatar.bot {
            background: linear-gradient(135deg, var(--accent-color), var(--accent-light));
        }

        .message-avatar.user {
            background-color: var(--bg-input);
        }

        .message-avatar.error {
            background-color: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .message-content {
            max-width: 75%;
        }

        @media (max-width: 768px) {
            .message-content {
                max-width: 85%;
            }
        }

        @media (min-width: 1024px) {
            .message-content {
                max-width: 80%;
            }
        }

        .message-bubble {
            padding: 14px 18px;
            border-radius: var(--radius-lg);
            font-size: 15px;
            line-height: 1.7;
        }

        .message.user .message-bubble {
            background-color: var(--accent-color);
            color: white;
            border-bottom-right-radius: var(--radius-sm);
        }

        .message.bot .message-bubble {
            background-color: var(--bg-message);
            border: 1px solid var(--border-color);
            border-bottom-left-radius: var(--radius-sm);
        }

        .message-bubble.error {
            color: #ef4444;
        }

        .message-image {
            margin-top: 8px;
            max-width: 200px;
            border-radius: var(--radius-md);
        }

        .structure-container {
            margin-top: 12px;
            background: white;
            padding: 12px;
            border-radius: var(--radius-md);
            display: inline-block;
        }

        .structure-image {
            max-width: 200px;
        }

        .audio-container {
            margin-top: 12px;
            background-color: var(--bg-input);
            padding: 12px;
            border-radius: var(--radius-md);
            max-width: 240px;
        }

        .audio-label {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        audio {
            width: 100%;
            height: 32px;
        }

        .media-placeholder {
            margin-top: 12px;
            padding: 12px;
            background-color: var(--bg-input);
            border-radius: var(--radius-md);
            font-size: 12px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Typing indicator */
        .typing {
            display: flex;
            gap: 4px;
            padding: 8px 0;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background-color: var(--text-muted);
            border-radius: 50%;
            animation: typing 1.4s ease-in-out infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-6px); }
        }

        /* Text formatting */
        .prose strong { color: var(--accent-color); font-weight: 600; }
        .prose em { font-style: italic; }
        .prose code {
            background-color: var(--bg-hover);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 13px;
            font-family: 'SF Mono', Monaco, monospace;
        }

        /* ===== INPUT AREA ===== */
        .input-area {
            padding: 16px 20px 24px;
        }

        @media (max-width: 480px) {
            .input-area {
                padding: 12px 12px 20px;
            }
        }

        @media (min-width: 1024px) {
            .input-area {
                padding: 20px 32px 28px;
            }
        }

        .input-container {
            max-width: 900px;
            margin: 0 auto;
        }

        @media (max-width: 768px) {
            .input-container {
                max-width: 100%;
            }
        }

        @media (min-width: 1440px) {
            .input-container {
                max-width: 1100px;
            }
        }

        .image-preview {
            margin-bottom: 12px;
        }

        .image-preview-content {
            display: inline-flex;
            align-items: flex-start;
            gap: 8px;
            padding: 8px;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
        }

        .preview-thumb {
            width: 48px;
            height: 48px;
            object-fit: cover;
            border-radius: var(--radius-sm);
        }

        .remove-preview-btn {
            width: 20px;
            height: 20px;
            background-color: rgba(239, 68, 68, 0.8);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: background 0.15s ease;
        }

        .remove-preview-btn:hover {
            background-color: #ef4444;
        }

        .input-box {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background-color: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            transition: all 0.15s ease;
        }

        .input-box:focus-within {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .input-btn {
            width: 32px;
            height: 32px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.15s ease;
            flex-shrink: 0;
        }

        .input-btn:hover {
            background-color: var(--bg-hover);
            color: var(--text-primary);
        }

        .text-input {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: var(--text-primary);
            font-size: 16px;
            font-family: inherit;
            resize: none;
            min-height: 26px;
            max-height: 120px;
            line-height: 26px;
            padding: 0;
        }

        .text-input::placeholder {
            color: var(--text-muted);
        }

        .send-btn {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--accent-color), var(--accent-light));
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.15s ease;
            flex-shrink: 0;
            box-shadow: 0 2px 8px var(--accent-glow);
        }

        .send-btn:hover {
            background: linear-gradient(135deg, var(--accent-hover), var(--accent-color));
            transform: scale(1.08);
            box-shadow: 0 4px 16px var(--accent-glow);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .input-disclaimer {
            text-align: center;
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 12px;
        }

        .file-input {
            display: none;
        }

        /* ===== SCROLLBAR ===== */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--border-light);
        }

        .hidden { display: none !important; }

        /* SVG Icons */
        .icon {
            width: 16px;
            height: 16px;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
        }

        .icon-sm { width: 14px; height: 14px; }
        .icon-lg { width: 20px; height: 20px; }

        /* ===== QUIZ COMPONENTS ===== */
        .quiz-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-top: 12px;
        }

        .quiz-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }

        .quiz-badge {
            font-size: 11px;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 20px;
            background: linear-gradient(135deg, var(--accent-color), var(--accent-light));
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .quiz-level {
            font-size: 11px;
            color: var(--text-muted);
        }

        .quiz-question {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 16px;
            line-height: 1.6;
        }

        .quiz-audio-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 16px;
            transition: all 0.15s ease;
        }

        .quiz-audio-btn:hover {
            background: var(--bg-hover);
            border-color: var(--accent-color);
        }

        .quiz-input { margin-bottom: 16px; }

        /* Radio Options (MCQ) */
        .quiz-radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .quiz-radio-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.15s ease;
            font-size: 15px;
            color: var(--text-primary);
        }

        .quiz-radio-option:hover {
            background: var(--bg-hover);
            border-color: var(--text-muted);
        }

        .quiz-radio-option.selected {
            border-color: var(--accent-color);
            background: rgba(59, 130, 246, 0.1);
        }

        .quiz-radio-option.correct {
            border-color: #22c55e;
            background: rgba(34, 197, 94, 0.15);
        }

        .quiz-radio-option.incorrect {
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.15);
        }

        .quiz-radio-option.disabled {
            pointer-events: none;
            opacity: 0.7;
        }

        .quiz-radio-circle {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-light);
            border-radius: 50%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .quiz-radio-option.selected .quiz-radio-circle {
            border-color: var(--accent-color);
        }

        .quiz-radio-option.selected .quiz-radio-circle::after {
            content: '';
            width: 10px;
            height: 10px;
            background: var(--accent-color);
            border-radius: 50%;
        }

        .quiz-radio-option.correct .quiz-radio-circle {
            border-color: #22c55e;
            background: #22c55e;
        }

        .quiz-radio-option.correct .quiz-radio-circle::after {
            content: '✓';
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .quiz-radio-option.incorrect .quiz-radio-circle {
            border-color: #ef4444;
            background: #ef4444;
        }

        .quiz-radio-option.incorrect .quiz-radio-circle::after {
            content: '✗';
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        /* Select Options (Matching) */
        .quiz-select-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .quiz-select-row {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .quiz-select-left {
            min-width: 100px;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 15px;
            font-weight: 600;
            color: var(--accent-light);
        }

        .quiz-select-dropdown {
            flex: 1;
            padding: 12px 16px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
        }

        .quiz-select-dropdown:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        /* Text Input (Free Text) */
        .quiz-text-input {
            width: 100%;
            padding: 14px 16px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 15px;
            font-family: inherit;
        }

        .quiz-text-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .quiz-text-input::placeholder {
            color: var(--text-muted);
        }

        /* Submit Button */
        .quiz-submit-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--accent-color), var(--accent-light));
            border: none;
            border-radius: var(--radius-md);
            color: white;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .quiz-submit-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px var(--accent-glow);
        }

        .quiz-submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Result */
        .quiz-result {
            margin-top: 16px;
            padding: 16px;
            border-radius: var(--radius-md);
            font-size: 14px;
            line-height: 1.6;
        }

        .quiz-result.correct {
            background: rgba(34, 197, 94, 0.15);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: #4ade80;
        }

        .quiz-result.incorrect {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #f87171;
        }

        .quiz-result-icon {
            font-size: 18px;
            margin-right: 8px;
        }

        .quiz-explanation {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
        }

        .quiz-answer-list {
            margin-top: 8px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-sm);
        }

        .quiz-answer-pair {
            padding: 4px 0;
            font-size: 14px;
        }

        .quiz-answer-pair strong {
            color: var(--accent-light);
            font-family: 'SF Mono', Monaco, monospace;
        }

        /* ===== LAPTOP/DESKTOP RESPONSIVENESS ===== */
        @media (min-width: 1024px) {
            /* Welcome section */
            .welcome-title {
                font-size: 42px;
            }

            .welcome-subtitle {
                font-size: 20px;
            }

            /* Feature cards */
            .feature-title {
                font-size: 18px;
            }

            .feature-desc {
                font-size: 15px;
            }

            /* Messages */
            .user-message, .bot-message {
                font-size: 16px;
            }

            /* Quiz */
            .quiz-question {
                font-size: 17px;
            }

            .quiz-option label {
                font-size: 16px;
            }

            /* Input area */
            .chat-input {
                font-size: 16px;
            }

            /* Sidebar */
            .logo-text {
                font-size: 21px;
            }

            .history-item-title {
                font-size: 15px;
            }

            /* Audio label */
            .audio-label {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo" onclick="startNewChat()" title="Về trang chủ">
                    <div class="logo-icon">&#9879;</div>
                    <div>
                        <div class="logo-text">CHEMI</div>
                        <div class="logo-subtitle">Trợ lý Hóa học</div>
                    </div>
                </div>
            </div>

            <nav class="sidebar-nav">
                <button onclick="startNewChat()" class="new-chat-btn">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                    Cuộc trò chuyện mới
                </button>

                <div class="nav-label">Gần đây</div>
                <div id="chatHistory" class="chat-history"></div>
            </nav>

        </aside>

        <!-- Main Content -->
        <main class="main">
            <!-- Animated Chemistry Icons Background -->
            <div class="chem-bg">
                <!-- Flask -->
                <div class="chem-icon">
                    <svg viewBox="0 0 24 24"><path d="M9 3h6v6l4 8a2 2 0 01-2 2H7a2 2 0 01-2-2l4-8V3"/><path d="M8 3h8"/></svg>
                </div>
                <!-- Atom -->
                <div class="chem-icon">
                    <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="2"/><ellipse cx="12" cy="12" rx="10" ry="4" transform="rotate(0 12 12)"/><ellipse cx="12" cy="12" rx="10" ry="4" transform="rotate(60 12 12)"/><ellipse cx="12" cy="12" rx="10" ry="4" transform="rotate(120 12 12)"/></svg>
                </div>
                <!-- Molecule -->
                <div class="chem-icon">
                    <svg viewBox="0 0 24 24"><circle cx="6" cy="12" r="3"/><circle cx="18" cy="8" r="2"/><circle cx="18" cy="16" r="2"/><line x1="9" y1="12" x2="16" y2="8"/><line x1="9" y1="12" x2="16" y2="16"/></svg>
                </div>
                <!-- Test Tube -->
                <div class="chem-icon">
                    <svg viewBox="0 0 24 24"><path d="M14.5 2v17.5c0 1.4-1.1 2.5-2.5 2.5s-2.5-1.1-2.5-2.5V2"/><path d="M8.5 2h7"/><path d="M14.5 16a2.5 2.5 0 01-5 0"/></svg>
                </div>
                <!-- Benzene Ring -->
                <div class="chem-icon">
                    <svg viewBox="0 0 24 24"><polygon points="12,2 20,7 20,17 12,22 4,17 4,7"/><polygon points="12,6 16,8.5 16,15.5 12,18 8,15.5 8,8.5"/></svg>
                </div>
                <!-- Beaker -->
                <div class="chem-icon">
                    <svg viewBox="0 0 24 24"><path d="M6 4h12v16a2 2 0 01-2 2H8a2 2 0 01-2-2V4z"/><path d="M6 4V2h12v2"/><path d="M6 14h12"/></svg>
                </div>
                <!-- H2O -->
                <div class="chem-icon">
                    <svg viewBox="0 0 24 24"><circle cx="12" cy="10" r="4"/><circle cx="6" cy="16" r="2.5"/><circle cx="18" cy="16" r="2.5"/><line x1="9" y1="12" x2="7" y2="14"/><line x1="15" y1="12" x2="17" y2="14"/></svg>
                </div>
                <!-- DNA Helix -->
                <div class="chem-icon">
                    <svg viewBox="0 0 24 24"><path d="M6 2c0 4 6 6 6 10s-6 6-6 10"/><path d="M18 2c0 4-6 6-6 10s6 6 6 10"/><line x1="6" y1="7" x2="18" y2="7"/><line x1="6" y1="12" x2="18" y2="12"/><line x1="6" y1="17" x2="18" y2="17"/></svg>
                </div>
                <!-- Erlenmeyer Flask -->
                <div class="chem-icon">
                    <svg viewBox="0 0 24 24"><path d="M10 2v7.31l-5 8.54A2 2 0 006.7 21h10.6a2 2 0 001.7-2.85l-5-8.54V2"/><line x1="8" y1="2" x2="16" y2="2"/><path d="M7 15h10"/></svg>
                </div>
                <!-- Periodic Element -->
                <div class="chem-icon">
                    <svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><text x="12" y="14" text-anchor="middle" font-size="8" fill="currentColor" stroke="none">Fe</text><text x="12" y="19" text-anchor="middle" font-size="4" fill="currentColor" stroke="none">26</text></svg>
                </div>
                <!-- Carbon Chain -->
                <div class="chem-icon">
                    <svg viewBox="0 0 24 24"><circle cx="4" cy="12" r="2"/><circle cx="10" cy="8" r="2"/><circle cx="16" cy="12" r="2"/><circle cx="22" cy="8" r="2"/><line x1="6" y1="11" x2="8" y2="9"/><line x1="12" y1="9" x2="14" y2="11"/><line x1="18" y1="11" x2="20" y2="9"/></svg>
                </div>
                <!-- Droplet -->
                <div class="chem-icon">
                    <svg viewBox="0 0 24 24"><path d="M12 2.69l5.66 5.66a8 8 0 11-11.31 0z"/></svg>
                </div>
            </div>

            <!-- Header -->
            <header class="header">
                <div class="header-left">
                    <!-- Mobile Home Button -->
                    <button class="mobile-home-btn" onclick="startNewChat()" title="Trang chủ">
                        <svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                    </button>
                    <div class="model-badge">
                        <span>Chemi xin chào</span>
                        <span class="model-badge-icon">&#128075;</span>
                    </div>
                </div>
                <div class="header-right">
                    <div class="status-badge">
                        <span class="status-dot"></span>
                        <span>Trực tuyến</span>
                    </div>
                </div>
            </header>

            <!-- Chat Area -->
            <div class="chat-area">
                <!-- Welcome Screen -->
                <div id="welcomeScreen" class="welcome">
                    <div class="welcome-icon">&#9879;</div>
                    <h1 class="welcome-title">Xin chào!</h1>
                    <p class="welcome-subtitle">Mình là trợ lý AI hỗ trợ gọi tên nguyên tố<br>và hợp chất hóa học theo chuẩn IUPAC</p>

                    <div class="features">
                        <button onclick="sendExample('Cho tôi bài tập trắc nghiệm về alkane')" class="feature-card structure">
                            <div class="feature-icon">
                                <svg viewBox="0 0 24 24"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
                            </div>
                            <div class="feature-content">
                                <div class="feature-title">Bài tập trắc nghiệm</div>
                                <div class="feature-desc">Luyện tập gọi tên theo nhiều mức độ</div>
                            </div>
                        </button>
                        <button onclick="sendExample('Phát âm Methane')" class="feature-card pronunciation">
                            <div class="feature-icon">
                                <svg viewBox="0 0 24 24"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
                            </div>
                            <div class="feature-content">
                                <div class="feature-title">Phát âm tiếng Anh</div>
                                <div class="feature-desc">Nghe phát âm theo danh pháp IUPAC</div>
                            </div>
                        </button>
                        <button onclick="sendExample('Ethanol là gì?')" class="feature-card iupac">
                            <div class="feature-icon">
                                <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><circle cx="12" cy="4" r="2"/><circle cx="12" cy="20" r="2"/><circle cx="4" cy="8" r="2"/><circle cx="20" cy="8" r="2"/><circle cx="4" cy="16" r="2"/><circle cx="20" cy="16" r="2"/><line x1="12" y1="9" x2="12" y2="6"/><line x1="12" y1="15" x2="12" y2="18"/><line x1="9.5" y1="10.5" x2="5.5" y2="9"/><line x1="14.5" y1="10.5" x2="18.5" y2="9"/><line x1="9.5" y1="13.5" x2="5.5" y2="15"/><line x1="14.5" y1="13.5" x2="18.5" y2="15"/></svg>
                            </div>
                            <div class="feature-content">
                                <div class="feature-title">Thông tin hợp chất</div>
                                <div class="feature-desc">Tra cứu tên, công thức và cấu trúc hóa học</div>
                            </div>
                        </button>
                        <button onclick="sendExample('Bài tập tự luận về danh pháp IUPAC')" class="feature-card quiz">
                            <div class="feature-icon">
                                <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                            </div>
                            <div class="feature-content">
                                <div class="feature-title">Bài tập tự luận</div>
                                <div class="feature-desc">Giải thích quy tắc gọi tên IUPAC</div>
                            </div>
                        </button>
                        <button onclick="sendExample('Bài tập nghe về alcohol')" class="feature-card speech">
                            <div class="feature-icon">
                                <svg viewBox="0 0 24 24"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>
                            </div>
                            <div class="feature-content">
                                <div class="feature-title">Chemistry Listening</div>
                                <div class="feature-desc">Listen to chemical descriptions and choose the correct substance</div>
                            </div>
                        </button>
                    </div>
                </div>

                <!-- Messages -->
                <div id="chatMessages" class="messages hidden"></div>
            </div>

            <!-- Input Area -->
            <div class="input-area">
                <div class="input-container">
                    <!-- Image Preview -->
                    <div id="imagePreviewArea" class="image-preview hidden">
                        <div class="image-preview-content">
                            <img id="previewThumb" src="" alt="Preview" class="preview-thumb">
                            <button onclick="removeImage()" class="remove-preview-btn">&times;</button>
                        </div>
                    </div>

                    <!-- Input Box -->
                    <div class="input-box">
                        <button onclick="document.getElementById('imageInput').click()" class="input-btn" title="Upload image">
                            &#128206;
                        </button>
                        <input type="file" id="imageInput" accept="image/*" onchange="handleImageSelect(event)" class="file-input">

                        <textarea id="textInput"
                            placeholder="Hỏi về hợp chất hóa học, công thức, bảng tuần hoàn..."
                            rows="1"
                            onkeydown="handleKeyDown(event)"
                            oninput="autoResize(this)"
                            class="text-input"></textarea>

                        <button id="sendBtn" onclick="sendMessage()" class="send-btn" title="Send">
                            &#10148;
                        </button>
                    </div>

                    <p class="input-disclaimer">
                        CHEMI có thể mắc lỗi. Hãy kiểm tra thông tin quan trọng.
                    </p>
                </div>
            </div>
        </main>
    </div>

    <script>
        // State
        let threadId = null;
        let selectedImage = null;
        let selectedImageBase64 = null;
        let isLoading = false;
        let chatHistory = [];
        let allSessions = [];
        let currentQuiz = null;

        const API_BASE = window.location.origin;

        const STORAGE_CONFIG = {
            maxSessions: 10,
            maxMessagesPerSession: 50,
            maxStorageSize: 4 * 1024 * 1024,
        };

        function processImageFile(file) {
            selectedImage = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                selectedImageBase64 = e.target.result.split(',')[1];
                document.getElementById('previewThumb').src = e.target.result;
                document.getElementById('imagePreviewArea').classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadSession();
            updateSessionDisplay();
            setupPasteHandler();
        });

        function setupPasteHandler() {
            document.addEventListener('paste', handlePaste);
        }

        function handlePaste(event) {
            const items = event.clipboardData?.items;
            if (!items) return;
            for (const item of items) {
                if (item.type.startsWith('image/')) {
                    event.preventDefault();
                    const file = item.getAsFile();
                    if (file) processImageFile(file);
                    break;
                }
            }
        }

        // Session Management
        function loadSession() {
            try {
                const savedSessions = localStorage.getItem('chemi_sessions');
                if (savedSessions) {
                    allSessions = JSON.parse(savedSessions);
                }

                // Always show home page on load - user can choose to load a session from sidebar
                // Clear current session so we start fresh
                localStorage.removeItem('chemi_current_session');
                threadId = null;
                chatHistory = [];
                showWelcome();

                renderSessionList();
            } catch (e) {
                console.error('Error loading session:', e);
                cleanupStorage();
            }
        }

        function saveSession() {
            if (!threadId || chatHistory.length === 0) return;

            try {
                const messagesForStorage = chatHistory.map((msg, idx) => {
                    const isRecent = idx >= chatHistory.length - 5;
                    return {
                        role: msg.role,
                        text: msg.text,
                        error: msg.error,
                        hasImage: !!msg.userImage || !!msg.structureImage,
                        hasAudio: !!msg.audio,
                        userImage: isRecent ? msg.userImage : null,
                        structureImage: isRecent ? msg.structureImage : null,
                        audio: isRecent ? msg.audio : null,
                        quizData: msg.quizData,
                        timestamp: msg.timestamp || Date.now()
                    };
                });

                const existingIdx = allSessions.findIndex(s => s.threadId === threadId);
                const sessionData = {
                    threadId,
                    title: chatHistory[0]?.text?.slice(0, 30) || 'New chat',
                    messages: messagesForStorage.slice(-STORAGE_CONFIG.maxMessagesPerSession),
                    updatedAt: Date.now()
                };

                if (existingIdx >= 0) {
                    allSessions[existingIdx] = sessionData;
                } else {
                    allSessions.unshift(sessionData);
                }

                allSessions.sort((a, b) => b.updatedAt - a.updatedAt);
                cleanupStorage();
                localStorage.setItem('chemi_sessions', JSON.stringify(allSessions));
                localStorage.setItem('chemi_current_session', threadId);
                renderSessionList();
            } catch (e) {
                console.error('Error saving session:', e);
                if (e.name === 'QuotaExceededError') {
                    cleanupStorage(true);
                    saveSession();
                }
            }
        }

        function cleanupStorage(aggressive = false) {
            const maxSessions = aggressive ? 5 : STORAGE_CONFIG.maxSessions;
            if (allSessions.length > maxSessions) {
                allSessions = allSessions.slice(0, maxSessions);
            }

            if (aggressive) {
                allSessions = allSessions.map(session => ({
                    ...session,
                    messages: session.messages.map(msg => ({
                        ...msg,
                        userImage: null,
                        structureImage: null,
                        audio: null
                    }))
                }));
            }

            const dataSize = new Blob([JSON.stringify(allSessions)]).size;
            if (dataSize > STORAGE_CONFIG.maxStorageSize && !aggressive) {
                cleanupStorage(true);
            }
        }

        function startNewChat() {
            if (threadId && chatHistory.length > 0) {
                saveSession();
            }

            threadId = null;
            chatHistory = [];
            selectedImage = null;
            selectedImageBase64 = null;
            localStorage.removeItem('chemi_current_session');
            updateSessionDisplay();
            showWelcome();
            document.getElementById('chatMessages').innerHTML = '';
            document.getElementById('imagePreviewArea').classList.add('hidden');
            renderSessionList();
        }

        function loadSessionById(id) {
            if (threadId && chatHistory.length > 0) {
                saveSession();
            }

            const session = allSessions.find(s => s.threadId === id);
            if (session) {
                threadId = session.threadId;
                chatHistory = session.messages || [];
                localStorage.setItem('chemi_current_session', threadId);
                updateSessionDisplay();
                showMessages();
                renderChatHistory();
                renderSessionList();
            }
        }

        function deleteSession(id, event) {
            event.stopPropagation();
            allSessions = allSessions.filter(s => s.threadId !== id);
            localStorage.setItem('chemi_sessions', JSON.stringify(allSessions));

            if (threadId === id) {
                startNewChat();
            }
            renderSessionList();
        }

        function updateSessionDisplay() {}

        function renderSessionList() {
            const historyDiv = document.getElementById('chatHistory');
            historyDiv.innerHTML = '';

            allSessions.forEach(session => {
                const item = document.createElement('button');
                const isActive = session.threadId === threadId;
                item.className = `history-item${isActive ? ' active' : ''}`;
                item.onclick = () => loadSessionById(session.threadId);

                const date = new Date(session.updatedAt);
                const timeStr = date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' });

                item.innerHTML = `
                    <span class="history-item-icon">&#128172;</span>
                    <div class="history-item-content">
                        <div class="history-item-title">${escapeHtml(session.title)}</div>
                        <div class="history-item-date">${timeStr}</div>
                    </div>
                    <button onclick="deleteSession('${session.threadId}', event)" class="history-delete-btn">&#128465;</button>
                `;
                historyDiv.appendChild(item);
            });
        }

        // UI State
        function showWelcome() {
            document.getElementById('welcomeScreen').classList.remove('hidden');
            document.getElementById('chatMessages').classList.add('hidden');
        }

        function showMessages() {
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('chatMessages').classList.remove('hidden');
        }

        // Image handling
        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (file) processImageFile(file);
        }

        function removeImage() {
            selectedImage = null;
            selectedImageBase64 = null;
            document.getElementById('imageInput').value = '';
            document.getElementById('imagePreviewArea').classList.add('hidden');
        }

        // Input handling
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function sendExample(text) {
            const input = document.getElementById('textInput');
            input.value = text;
            input.focus();
            autoResize(input);
        }

        // Send message
        async function sendMessage() {
            const textInput = document.getElementById('textInput');
            const text = textInput.value.trim();

            if (!text && !selectedImageBase64) return;
            if (isLoading) return;

            isLoading = true;
            showMessages();

            addMessage('user', text, selectedImageBase64 ? `data:image/png;base64,${selectedImageBase64}` : null);

            textInput.value = '';
            textInput.style.height = 'auto';
            const imageBase64ToSend = selectedImageBase64;
            removeImage();

            const loadingId = addLoadingMessage();
            document.getElementById('sendBtn').disabled = true;

            try {
                const response = await fetch(`${API_BASE}/query`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: text || null,
                        image_base64: imageBase64ToSend || null,
                        thread_id: threadId
                    })
                });

                const data = await response.json();
                removeLoadingMessage(loadingId);

                if (data.success) {
                    threadId = data.thread_id;
                    updateSessionDisplay();
                    saveSession();
                    addMessage('bot', data.text_response, null, data.image_base64, data.audio_base64, null, data.quiz_data);
                } else {
                    addMessage('bot', null, null, null, null, data.error || 'Có lỗi xảy ra.', null);
                }
            } catch (error) {
                removeLoadingMessage(loadingId);
                addMessage('bot', null, null, null, null, 'Không thể kết nối server.');
            }

            isLoading = false;
            document.getElementById('sendBtn').disabled = false;
        }

        // Message rendering
        function addMessage(role, text, userImage = null, structureImage = null, audio = null, error = null, quizData = null) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            let content = '';

            if (role === 'user') {
                content = `
                    <div class="message-avatar user">&#128100;</div>
                    <div class="message-content">
                        <div class="message-bubble">${escapeHtml(text)}</div>
                        ${userImage ? `<img src="${userImage}" class="message-image" alt="Uploaded">` : ''}
                    </div>
                `;
            } else {
                if (error) {
                    content = `
                        <div class="message-avatar error">!</div>
                        <div class="message-content">
                            <div class="message-bubble error">${escapeHtml(error)}</div>
                        </div>
                    `;
                } else {
                    let mediaHtml = '';
                    if (structureImage) {
                        const imgSrc = structureImage.startsWith('http') ? structureImage : `data:image/png;base64,${structureImage}`;
                        mediaHtml += `
                            <div class="structure-container">
                                <img src="${imgSrc}" alt="Structure" class="structure-image">
                            </div>
                        `;
                    }
                    // Only show audio if NOT listening quiz (listening quiz audio will be inside quiz)
                    if (audio && (!quizData || quizData.type !== 'listening')) {
                        const audioSrc = audio.startsWith('http') ? audio : `data:audio/wav;base64,${audio}`;
                        mediaHtml += `
                            <div class="audio-container">
                                <p class="audio-label">&#128266; Phát âm</p>
                                <audio controls>
                                    <source src="${audioSrc}" type="audio/wav">
                                </audio>
                            </div>
                        `;
                    }
                    // Render quiz if present (pass audio for listening type)
                    if (quizData && quizData.quiz_id) {
                        mediaHtml += renderQuiz(quizData, audio);
                    }

                    content = `
                        <div class="message-avatar bot">&#9879;</div>
                        <div class="message-content">
                            <div class="message-bubble">
                                <div class="prose">${formatMarkdown(text || '')}</div>
                            </div>
                            ${mediaHtml}
                        </div>
                    `;
                }
            }

            messageDiv.innerHTML = content;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            chatHistory.push({ role, text, userImage, structureImage, audio, error, quizData });
            saveSession();
        }

        function addLoadingMessage() {
            const messagesDiv = document.getElementById('chatMessages');
            const loadingDiv = document.createElement('div');
            const loadingId = 'loading-' + Date.now();
            loadingDiv.id = loadingId;
            loadingDiv.className = 'message bot';
            loadingDiv.innerHTML = `
                <div class="message-avatar bot">&#9879;</div>
                <div class="message-content">
                    <div class="message-bubble">
                        <div class="typing">
                            <span class="typing-dot"></span>
                            <span class="typing-dot"></span>
                            <span class="typing-dot"></span>
                        </div>
                    </div>
                </div>
            `;
            messagesDiv.appendChild(loadingDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            return loadingId;
        }

        function removeLoadingMessage(id) {
            document.getElementById(id)?.remove();
        }

        function renderChatHistory() {
            const messagesDiv = document.getElementById('chatMessages');
            messagesDiv.innerHTML = '';

            chatHistory.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${msg.role}`;

                let content = '';
                if (msg.role === 'user') {
                    let imageHtml = '';
                    if (msg.userImage) {
                        imageHtml = `<img src="${msg.userImage}" class="message-image" alt="Uploaded">`;
                    } else if (msg.hasImage) {
                        imageHtml = `<div class="media-placeholder">&#128444; Hình ảnh đã được dọn dẹp</div>`;
                    }

                    content = `
                        <div class="message-avatar user">&#128100;</div>
                        <div class="message-content">
                            <div class="message-bubble">${escapeHtml(msg.text)}</div>
                            ${imageHtml}
                        </div>
                    `;
                } else {
                    if (msg.error) {
                        content = `
                            <div class="message-avatar error">!</div>
                            <div class="message-content">
                                <div class="message-bubble error">${escapeHtml(msg.error)}</div>
                            </div>
                        `;
                    } else {
                        let mediaHtml = '';

                        if (msg.structureImage) {
                            const imgSrc = msg.structureImage.startsWith('http') ? msg.structureImage : `data:image/png;base64,${msg.structureImage}`;
                            mediaHtml += `<div class="structure-container"><img src="${imgSrc}" alt="Cấu trúc" class="structure-image"></div>`;
                        } else if (msg.hasImage) {
                            mediaHtml += `<div class="media-placeholder">&#128444; Hình ảnh cấu trúc đã được dọn dẹp</div>`;
                        }

                        if (msg.audio) {
                            const audioSrc = msg.audio.startsWith('http') ? msg.audio : `data:audio/wav;base64,${msg.audio}`;
                            mediaHtml += `<div class="audio-container"><p class="audio-label">&#128266; Phát âm</p><audio controls><source src="${audioSrc}" type="audio/wav"></audio></div>`;
                        } else if (msg.hasAudio) {
                            mediaHtml += `<div class="media-placeholder">&#128264; Audio đã được dọn dẹp</div>`;
                        }

                        // Render quiz if present (show as completed/disabled for history)
                        if (msg.quizData && msg.quizData.quiz_id) {
                            mediaHtml += renderQuizFromHistory(msg.quizData);
                        }

                        content = `
                            <div class="message-avatar bot">&#9879;</div>
                            <div class="message-content">
                                <div class="message-bubble">
                                    <div class="prose">${formatMarkdown(msg.text || '')}</div>
                                </div>
                                ${mediaHtml}
                            </div>
                        `;
                    }
                }

                messageDiv.innerHTML = content;
                messagesDiv.appendChild(messageDiv);
            });
        }

        // Render quiz from history (display only, no interaction)
        function renderQuizFromHistory(quiz) {
            let html = `<div class="quiz-container" data-quiz-id="${quiz.quiz_id}">`;
            html += `<div class="quiz-header">`;
            html += `<span class="quiz-badge">${escapeHtml(quiz.type.toUpperCase())}</span>`;
            html += `</div>`;
            html += `<div class="quiz-question">${escapeHtml(quiz.question_text)}</div>`;

            // Show options as disabled
            if (quiz.input_type === 'radio' && quiz.options) {
                html += '<div class="quiz-input"><div class="quiz-radio-group">';
                quiz.options.forEach(opt => {
                    const isCorrect = opt.charAt(0).toUpperCase() === quiz.correct_answer.toUpperCase();
                    html += `<div class="quiz-radio-option disabled ${isCorrect ? 'correct' : ''}">`;
                    html += `<div class="quiz-radio-circle"></div>`;
                    html += `<span>${escapeHtml(opt)}</span>`;
                    html += `</div>`;
                });
                html += '</div></div>';
            }

            // Format answer for display
            let formattedAnswer = escapeHtml(quiz.correct_answer);
            if (quiz.input_type === 'select') {
                try {
                    const pairs = JSON.parse(quiz.correct_answer);
                    formattedAnswer = '<div class="quiz-answer-list">' +
                        Object.entries(pairs)
                            .map(([left, right]) => `<div class="quiz-answer-pair"><strong>${escapeHtml(left)}</strong> → ${escapeHtml(right)}</div>`)
                            .join('') +
                        '</div>';
                } catch (e) {}
            }

            html += `<div class="quiz-result correct">`;
            html += `<span class="quiz-result-icon">&#10004;</span>`;
            html += `<span>Đáp án:</span>`;
            html += quiz.input_type === 'select' ? formattedAnswer : ` <strong>${formattedAnswer}</strong>`;
            html += `<div class="quiz-explanation">${escapeHtml(quiz.explanation || '')}</div>`;
            html += `</div>`;
            html += `</div>`;

            return html;
        }

        // Utilities
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatMarkdown(text) {
            if (!text) return '';
            let html = escapeHtml(text);
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
            html = html.replace(/`(.*?)`/g, '<code>$1</code>');
            html = html.replace(/\n/g, '<br>');
            return html;
        }

        // ============== QUIZ FUNCTIONS ==============

        function renderQuiz(quiz, audio = null) {
            currentQuiz = quiz;

            let html = `<div class="quiz-container" data-quiz-id="${quiz.quiz_id}">`;
            html += `<div class="quiz-header">`;
            html += `<span class="quiz-badge">${escapeHtml(quiz.type.toUpperCase())}</span>`;
            html += `</div>`;

            // Audio player for listening type
            if (quiz.type === 'listening' && audio) {
                const audioSrc = audio.startsWith('http') ? audio : `data:audio/wav;base64,${audio}`;
                html += `
                    <div class="audio-container" style="margin-bottom: 16px;">
                        <p class="audio-label">&#128266; Nghe mô tả và chọn đáp án</p>
                        <audio controls style="width: 100%;">
                            <source src="${audioSrc}" type="audio/wav">
                        </audio>
                    </div>
                `;
            }

            html += `<div class="quiz-question">${escapeHtml(quiz.question_text)}</div>`;
            html += `<div class="quiz-input">`;

            // Render input based on input_type
            switch(quiz.input_type) {
                case 'radio':
                    html += renderRadioInput(quiz.options || []);
                    break;
                case 'select':
                    html += renderSelectInput(quiz.match_items || []);
                    break;
                case 'text':
                    html += `<input type="text" class="quiz-text-input" placeholder="Nhập câu trả lời..." onkeydown="if(event.key==='Enter')submitQuizAnswer()">`;
                    break;
            }

            html += `</div>`;
            html += `<button class="quiz-submit-btn" onclick="submitQuizAnswer()">&#10003; Trả lời</button>`;
            html += `<div class="quiz-result-area"></div>`;
            html += `</div>`;

            return html;
        }

        function renderRadioInput(options) {
            let html = '<div class="quiz-radio-group">';
            options.forEach((opt, idx) => {
                html += `<div class="quiz-radio-option" onclick="selectRadioOption(this, '${escapeHtml(opt.charAt(0))}')">`;
                html += `<div class="quiz-radio-circle"></div>`;
                html += `<span>${escapeHtml(opt)}</span>`;
                html += `</div>`;
            });
            html += '</div>';
            return html;
        }

        function renderSelectInput(matchItems) {
            let html = '<div class="quiz-select-group">';
            matchItems.forEach((item, idx) => {
                html += `<div class="quiz-select-row">`;
                html += `<span class="quiz-select-left">${escapeHtml(item.left)}</span>`;
                html += `<select class="quiz-select-dropdown" data-left="${escapeHtml(item.left)}">`;
                html += `<option value="">-- Chọn --</option>`;
                (item.right_options || []).forEach(opt => {
                    html += `<option value="${escapeHtml(opt)}">${escapeHtml(opt)}</option>`;
                });
                html += `</select>`;
                html += `</div>`;
            });
            html += '</div>';
            return html;
        }

        function selectRadioOption(element, value) {
            const container = element.closest('.quiz-container');
            if (container.querySelector('.quiz-result')) return; // Already answered

            container.querySelectorAll('.quiz-radio-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            element.classList.add('selected');
            element.dataset.value = value;
        }

        function getQuizAnswer(inputType) {
            const container = document.querySelector(`.quiz-container[data-quiz-id="${currentQuiz.quiz_id}"]`);
            if (!container) return null;

            switch(inputType) {
                case 'radio':
                    const selected = container.querySelector('.quiz-radio-option.selected');
                    return selected ? selected.dataset.value : null;
                case 'select':
                    const pairs = {};
                    container.querySelectorAll('.quiz-select-dropdown').forEach(sel => {
                        if (sel.value) pairs[sel.dataset.left] = sel.value;
                    });
                    return JSON.stringify(pairs);
                case 'text':
                    const input = container.querySelector('.quiz-text-input');
                    return input ? input.value.trim() : null;
            }
            return null;
        }

        function submitQuizAnswer() {
            if (!currentQuiz) return;

            const answer = getQuizAnswer(currentQuiz.input_type);
            if (!answer) {
                alert('Vui lòng chọn hoặc nhập câu trả lời!');
                return;
            }

            const container = document.querySelector(`.quiz-container[data-quiz-id="${currentQuiz.quiz_id}"]`);
            if (!container) return;

            // Disable further input
            container.querySelectorAll('.quiz-radio-option').forEach(opt => opt.classList.add('disabled'));
            container.querySelectorAll('.quiz-select-dropdown').forEach(sel => sel.disabled = true);
            container.querySelectorAll('.quiz-text-input').forEach(inp => inp.disabled = true);
            container.querySelector('.quiz-submit-btn').disabled = true;

            if (currentQuiz.check_method === 'exact') {
                // Frontend check - instant feedback
                const isCorrect = checkExactAnswer(currentQuiz, answer);
                showQuizResult(container, isCorrect, currentQuiz.explanation, currentQuiz.correct_answer);
                showFollowUp();
            } else {
                // Fuzzy check - send to LLM
                const textInput = document.getElementById('textInput');
                textInput.value = `Câu trả lời của tôi: ${answer}`;
                sendMessage();
            }
        }

        function checkExactAnswer(quiz, answer) {
            if (quiz.input_type === 'select') {
                // For matching, compare JSON
                try {
                    const userPairs = JSON.parse(answer);
                    const correctPairs = JSON.parse(quiz.correct_answer);
                    return JSON.stringify(userPairs) === JSON.stringify(correctPairs);
                } catch {
                    return false;
                }
            }
            // For radio (MCQ), compare single letter
            return answer.toUpperCase() === quiz.correct_answer.toUpperCase();
        }

        function showQuizResult(container, isCorrect, explanation, correctAnswer) {
            // Highlight correct/incorrect options for radio type
            if (currentQuiz.input_type === 'radio') {
                container.querySelectorAll('.quiz-radio-option').forEach(opt => {
                    const optLetter = opt.dataset.value || opt.textContent.trim().charAt(0);
                    if (optLetter.toUpperCase() === correctAnswer.toUpperCase()) {
                        opt.classList.add('correct');
                    } else if (opt.classList.contains('selected')) {
                        opt.classList.add('incorrect');
                    }
                });
            }

            const resultArea = container.querySelector('.quiz-result-area');
            const icon = isCorrect ? '&#10004;' : '&#10008;';
            const resultClass = isCorrect ? 'correct' : 'incorrect';

            // Format correct answer for matching type
            let formattedAnswer = correctAnswer;
            if (currentQuiz.input_type === 'select') {
                try {
                    const pairs = JSON.parse(correctAnswer);
                    formattedAnswer = Object.entries(pairs)
                        .map(([left, right]) => `<div class="quiz-answer-pair"><strong>${escapeHtml(left)}</strong> → ${escapeHtml(right)}</div>`)
                        .join('');
                } catch (e) {
                    formattedAnswer = escapeHtml(correctAnswer);
                }
            }

            const resultText = isCorrect
                ? 'Chính xác!'
                : `Sai rồi! Đáp án đúng:`;

            resultArea.innerHTML = `
                <div class="quiz-result ${resultClass}">
                    <span class="quiz-result-icon">${icon}</span>
                    <span>${resultText}</span>
                    ${!isCorrect && currentQuiz.input_type === 'select' ? `<div class="quiz-answer-list">${formattedAnswer}</div>` : (!isCorrect ? ` <strong>${escapeHtml(correctAnswer)}</strong>` : '')}
                    <div class="quiz-explanation">${escapeHtml(explanation)}</div>
                </div>
            `;
        }

        function showFollowUp() {
            // Add a simple bot message asking if they want more questions
            setTimeout(() => {
                const messagesDiv = document.getElementById('chatMessages');
                const followUpDiv = document.createElement('div');
                followUpDiv.className = 'message bot';
                followUpDiv.innerHTML = `
                    <div class="message-avatar bot">&#9879;</div>
                    <div class="message-content">
                        <div class="message-bubble">
                            <div class="prose">Bạn có muốn làm thêm câu hỏi khác không? &#128218;</div>
                        </div>
                    </div>
                `;
                messagesDiv.appendChild(followUpDiv);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }, 500);
        }

    </script>
</body>
</html>
